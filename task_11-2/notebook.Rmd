---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(readr)
library(zoo)
library(tseries)
library(TSA)
```

Загружаем данные:
```{r}
data <- read_delim("SBER_140101_140401.csv", 
";", escape_double = FALSE, col_types = cols(`<DATE>` = col_date(format = "%Y%m%d"), 
`<PER>` = col_skip(), `<TICKER>` = col_skip(), 
`<TIME>` = col_skip()), trim_ws = TRUE)

zoo_data = read.zoo(data)
plot(zoo_data, col='blue', lwd=2)
```

```{r}
zoo_data_diff = log(zoo_data) / lag(log(zoo_data), -1, na.pad=TRUE)
zoo_data_diff = na.omit(zoo_data_diff)

plot(zoo_data_diff)
```


```{r}
USED_COL = '<HIGH>'

Intervention.Time = as.Date("2014-03-03")

plot(zoo_data_diff[,USED_COL], col='blue', lwd=2)
abline(v = Intervention.Time,col = "red",lwd = 3)
```

```{r}
wnd = window(zoo_data_diff, end=Intervention.Time)
plot(wnd[,USED_COL], col='blue', lwd=2)
```
```{r}
dwnd = diff(wnd)
plot(dwnd[,USED_COL])
```
```{r}
pacf(na.remove(as.ts(zoo_data_diff[,USED_COL])), lwd=4, lag.max=nrow(wnd))
```

```{r}
acf(na.remove(as.ts(dwnd[,USED_COL])), lwd=4, lag.max=nrow(wnd))
```
```{r}
pacf(na.remove(as.ts(dwnd[,USED_COL])), lwd=4, lag.max=nrow(wnd))
```
```{r}
Inter= 1 * (index(zoo_data_diff[,USED_COL]) == Intervention.Time)
xreg = data.frame(Inter)
xreg
```
```{r}
1 * (index(zoo_data_diff[,USED_COL]) == Intervention.Time)
```

```{r}
time(zoo_data_diff[,USED_COL]) == time(Intervention.Time)
```


```{r}
data.arima = arimax(
  na.remove(as.ts(zoo_data_diff[,USED_COL])),
  order=c(1,1,0),
  method='ML',
  xtransf=data.frame(Inter, Inter),
  transfer=list(c(0,0), c(2,0))
)

data.arima
```

```{r}
plot(as.numeric(zoo_data_diff[,USED_COL]), col='blue', lwd=2, type='o')
lines(as.numeric(na.remove(fitted(data.arima)[-1])),col= "red",lwd =2, type='p')
# abline(v = Intervention.Time,col = "red",lwd = 3)
# abline(v = 40,col = "red",lwd = 3)
```

```{r}
u00 = data.arima$coef["Inter-MA0"]
u10 = data.arima$coef["Inter.1-MA0"]
r11 = data.arima$coef["Inter.1-AR1"]
r12 = data.arima$coef["Inter.1-AR2"]
data.arima$coef
```

```{r}
filter(Inter,filter)
```

```{r}
inter_feed = Inter*u00 + filter(Inter, filter=c(r11, r12), method='recursive', side=1)*u10
plot(inter_feed, type='h', col='blue', lwd=2)
abline(h=0)
```
```{r}
data.inter_removed = as.numeric(zoo_data_diff[,USED_COL]) - inter_feed
plot(data.inter_removed, col='blue', lwd=2)
```


```{r}
acf(data.inter_removed, lwd=4, lag.max=length(data.inter_removed))
```

```{r}
pacf(data.inter_removed, lwd=4, lag.max=length(data.inter_removed))
```

```{r}
data.arima2 = arimax(
  data.inter_removed,
  order=c(1,0,1),
  method='ML'
)

plot(as.numeric(data.inter_removed), col='blue', lwd=2, type='o')
lines(as.numeric(na.remove(fitted(data.arima2))),col= "red",lwd =2, type='p')
# abline(v = Intervention.Time,col = "red",lwd = 3)
abline(v = 40,col = "red",lwd = 3)
```

```{r}
plot(data.arima2$residuals, col='blue', lwd=2)
```

```{r}
qqnorm(data.arima2$residuals)
qqline(data.arima2$residuals)
```
